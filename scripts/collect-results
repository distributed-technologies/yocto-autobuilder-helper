#!/bin/bash
WORKDIR=$1
DEST=$2
target=$3

RESFILE=$WORKDIR/tmp/log/oeqa/testresults.json 

if [ -e $RESFILE ]; then
    mkdir -p $DEST/$target
    cp $WORKDIR/tmp/log/oeqa/testresults.json  $DEST/$target/
fi

if [ -e $WORKDIR/buildhistory ]; then
    # ab-fetchrev tag set in buildhistory-init
    if [ $(git -C $WORKDIR/buildhistory tag -l "ab-fetchrev") ]; then
        mkdir -p $DEST/$target
        $WORKDIR/../scripts/buildhistory-diff -p $WORKDIR/buildhistory ab-fetchrev > $DEST/$target/buildhistory.txt
    fi
fi

HSFILE=$WORKDIR/tmp/buildstats/*/host_stats
d=`date +%Y-%m-%d--%H-%M`

mkdir -p $DEST/$target/$d

step=0
for f in $HSFILE; do
	if [ -e $f ]; then
	    cp $f $DEST/$target/$d
	    grep -m 1 "^top -" $f
	    if [ $? -eq 0 ]; then
		    mv $DEST/$target/$d/`basename $f` $DEST/$target/$d/`basename $f`_${step}_top.txt
	    else
		    mv $DEST/$target/$d/`basename $f` $DEST/$target/$d/`basename $f`_${step}.txt
	    fi
	    step=$((step+1))
	fi
done
